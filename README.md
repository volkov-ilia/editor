# tools

## Предварительная настройка Husky

Необходимые скрипты для запуска husky `pre-commit` и `pre-push` (должны находиться в папке `.husky/`)

С выходом версии husky 4 все скрипты хранятся в отдельной папке вместо package.json. Поэтому перед запуском проекта необходимо запустить команду из корня проекта:

`yarn husky-prepare`

Затем должна быть создана папка `_` внутри `.husky/`.

Готово.

Сделайте тестовый коммит для проверки.

## Первичная настройка проекта

1. Попросить у работающих на проекте прислать переменные окружения и их расположении, а также файлы сертификата и приватного ключа, которые должны находиться в `tools/nginx/certificates`.
2. [Настройка доменного имени для локального сервера](#настройка-доменного-имени-для-локального-сервера)
3. [Добавление самодельного сертификата локального сервера в доверие хрома](#добавление-самодельного-сертификата-локального-сервера-в-доверие-хрома)
4. [Формирование базы данных](#формирование-базы-данных)

### Настройка доменного имени для локального сервера

Необходимо добавить в файл с хостами новую пару IP/host для автоматического перенаправления запроса с IP на адрес новый адрес. Для этого нужно найти файл, где данные хосты прописываются.
Linux: `/etc/hosts`, Win: `C:\Windows\System32\drivers\etc\hosts`.

Алгоритм Linux:
1. в консоли прописываем команду: sudo nano /etc/hosts
2. в файле, ниже localhost, добавляем строчку:
```
127.0.0.1	tools.hwdtech.ru
```
3. сохраняем и выходим из файла

Алгоритм Windows:
1. Открыть файл с содержимым хоста любым удобным способом.
2. Добавить строчку:
```
127.0.0.1	tools.hwdtech.ru
```
3. Сохранить файл.

В результате каждый запрос tools.hwdtech.ru будет обращаться по 127.0.0.1:80(443)

**Внимание!**
Если приложение будет открываться НЕ на виртуальной машине, а через мост на машине-хост, в таком случае необходимо узнать адрес своей виртуальной машины и вместо адреса 127.0.0.1 указать адрес **своей виртуальной машины**!

Для определения адреса виртуальной машины можно воспользоваться `ifconfig`.

### Добавление самодельного сертификата локального сервера в доверие хрома

Чтобы сайт открывался без предупреждения о небезопасном подключении, важно установить подготовленный сертификат и приватный ключ.

Алгоритм на Linux:
1. в адресную строку вносим chrome://settings/certificates
2. во вкладке Authrorities(Центры Сертификации) нажимаем импорт файла
3. далее по пути ../tools/nginx/certificates выбираем файл localhost.crt
4. отмечаем все галочки, подтверждаем и обновляем страницу, для которой устанавливали доверие.
   Хром должен отметить, что страница защищена

Алгоритм на Windows:
1. Открыть в адресной строке браузера `chrome://settings/security`, затем `Управление сертификатами устройства`.
2. Должно открыться окно с сертификатами устройства. Во вкладке `Довверенные корневые центры сертификации`.
3. Нажать импорт.
4. Выбрать необходимый файл. 
5. Завершить установку без изменений.
6. Найти добавленный сертификат в списке.
7. Удостовериться, что во вкладке `Дополнительно` отмечены все галочки.
8. Перезапустить браузер.
9. Готово.

## Формирование базы данных

В папке `tools/mongodb` выполните команду: `sudo bash initDbCustomScript.sh`

## Запуск версии для разработки

в папке dockerfiles

1. сборка проекта: `docker compose -f allApps.yml build && docker image prune -f`
2. запуск: `docker compose -f allApps.yml up`

Пересборку необходимо осуществлять только если меняется докерфайл или добавляются новые модули.\
Перезапуск выполняется, если изменены настройки docker compose. Например, изменились порты или нужно пробросить новый том

## Запуск на проде

1. собираем последние изменения с ветки main (под своей учеткой)
2. если существуют запущенные контейнеры, завершаем их работу и чистим диск от лишних образов и томов (в readMe dockerfiles)
3. если база данных не существует, добавляем по алгоритму, указанному выше
4. запускаем проект, в папке dockerfiles: `docker compose -f prod.yml up && docker image prune -f`\
   В случае возникновения ошибки о нехватке места на диске, собирать проект следует раздельно.\
   `docker compose -f prod.yml build _containerName_ && docker image prune -f`

## Исправление некоторых локальных ошибок

### Не найдены файлы сертификатов в контейнере nginx
**Error response from daemon: failed to create shim task: OCI runtime create failed: run create failed unable to start container process: error during container init: error mounting: `"path/to/project/tools/nginx/certificates/localhost.crt"` to rootfs at `"etc/ssl/certs/localhost.crt"`: mount path/to/project/tools/nginx/certificates/localhost.crt:etc/ssl/certs/localhost.crt (via /proc/self/fd/6), flags: 0x5000: not directory: unknown: `Are you trying to mount a directory onto a file (or vice-versa)? Check if the specified host path exists and is the expected type`**

Необходимо проверить действительно ли в папке `path/to/project/tools/nginx/certificates/` содержатся необходимые файлы. А также не были ли созданы папки с данным названием.

Если созданы - удалить. Добавить файлы сертификатов (см. [Первичная настройка проекта, п.1](#первичная-настройка-проекта))

### Не добавляются картинки на стороне bin-api
Проверить наличие папки `path/to/project/tools/bin-api/img/`. Если существует, но не публикуются картинки, необходимо проверить права доступа к папке.

Если папка доступна только админу - расширить права для обычных пользователей либо удалить и вручную создать.
